import time
import random
import pandas as pd
import requests
import datetime


# 設定一些通用函數
def GetStockTabel(TargetDate, TargetStock, TargetDataframe):
    # 設定路徑
    url = "https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=html&date=" + \
        str(TargetDate) + "&stockNo=" + str(TargetStock)
    # read_html是一個dataframe的list，目前這個資料撈回來都在第0個index，所以要用[0]，才會存成一個dataframe
    data = pd.read_html(requests.get(url).text)[0]
    # 因為讀進來的Dataframe有兩個columns，index為0的column我們不需要，透過下功能，只讀取第一列的column
    data.columns = data.columns.get_level_values(1)
    # 新建一個dataframe，內容是由我們的參數dataframe垂直併入讀進來的dataframe，並忽略索引值（讓資料可以按照原索引編號繼續下去）
    NewTargetDataframe = pd.concat([TargetDataframe, data], ignore_index=True)
    return NewTargetDataframe

# 這個日期轉換，主要用來產出網址在用的日期，輸入參數為int，輸出為str


def GetStrTargetdate(Year, Month, day):
    # 因為月份會有1~9月，前面沒有0的問題，而在作為網址參數時卻是必要，因此透過str的zfill功能，讓前面補0
    StrTargetdate = str(Year)+str(Month).zfill(2)+str(day).zfill(2)
    return StrTargetdate

# 這個日期轉換，主要用來產出比對下載資料中的日期，輸入參數為date，輸出為str


def GetSearchDate(date):
    date = date.strftime('%Y%m%d')
    searchdate = str(int(str(date)[0:4])-1911) + \
        '/'+str(date)[4:6]+'/'+str(date)[6:8]
    return searchdate

# 這個日期轉換，主要將文字日期轉換為Date，輸入參數為str，輸出為date


def GetDateTargetdate(Strdate):
    # 強制將文字日期，轉換為日期格式
    transdate = datetime.date(int(Strdate[0:4]), int(
        Strdate[4:6]), int(Strdate[6:8]))
    return transdate


# def GetBuyDate(date, freq, series):
#     newdate = (date + datetime.timedelta(days=freq)).strftime('%Y%m%d')
#     searchdate = str(int(str(newdate)[0:4])-1911) + \
#         '/'+str(newdate)[4, 6]+'/'+str(newdate)[6, 8]
#     count = 0
#     while count < 1:
#         if searchdate in list(series):
#             # 未完

    # 設定輸入選項
TargetStock = input("請輸入投資項目股票代號，範例：2330。")
InitialTime = input("請輸入投資開始年月日，範例：20210701。")
Payment = int(input("請輸入定期定額投入金額，範例：10000。"))
Freq = int(input("請輸入幾天定期投入一次，範例：30。"))

# TargetStock = '2330'
# InitialTime = '20210601'的
# Payment = '10000'
# Freq = '30'

# 拆解輸入選項，以作為URL參數
InitialYear = int(InitialTime[0:4])
# 在讀取月份時，可能會有1~9月以01的方式出現，因此利用zfill功能，讓前面為0的自動消失
InitialMonth = int(InitialTime[4:6].zfill(1))
InitialDay = int(InitialTime[6:8].zfill(1))
TimeNow = time.localtime()
YearNow = TimeNow.tm_year
# 在讀取月份時，會有1~9月前面沒有0情況，因此利用zfill功能讓前面補0
MonthNow = TimeNow.tm_mon
DayNow = TimeNow.tm_mday

# debug
# print(InitialYear)
# print(InitialMonth)
# print(YearNow)
# print(MonthNow)

# 創造收取資料的dataframe
SD = pd.DataFrame()
# 設定請求的delaytime，以這個網站為例，5秒內存取3次會被鎖IP
DelayTime = [2.5, 2.6, 2.55, 2.65]
# 完成進度比率，a代表以下載的次數，b代表總共需要下載的次數
a = 0
b = 0
for year in range(InitialYear, YearNow + 1, 1):
    if InitialYear != YearNow:
        if year == InitialYear:
            for month_1 in range(InitialMonth, 13, 1):
                b = b+1
        elif year == YearNow:
            for month_2 in range(1, MonthNow+1, 1):
                b = b+1
        else:
            for month_3 in range(1, 12, 1):
                b = b+1
    else:
        for month_4 in range(InitialMonth, MonthNow + 1, 1):
            b = b+1

# print(b)

# 開始查詢迴圈
for year in range(InitialYear, YearNow + 1, 1):
    if InitialYear != YearNow:
        if year == InitialYear:
            for month_1 in range(InitialMonth, 13, 1):
                d1 = GetStrTargetdate(year, month_1, 1)
                SD = GetStockTabel(d1, TargetStock, SD)
                time.sleep(random.choice(DelayTime))
                a = a+1
                print('進度: {:.0%}'.format(a/b))
        elif year == YearNow:
            for month_2 in range(1, MonthNow+1, 1):
                d2 = GetStrTargetdate(year, month_2, 1)
                SD = GetStockTabel(d2, TargetStock, SD)
                time.sleep(random.choice(DelayTime))
                a = a+1
                print('進度: {:.0%}'.format(a/b))
        else:
            for month_3 in range(1, 12, 1):
                d3 = GetStrTargetdate(year, month_3, 1)
                SD = GetStockTabel(d3, TargetStock, SD)
                time.sleep(random.choice(DelayTime))
                a = a+1
                print('進度: {:.0%}'.format(a/b))
    else:
        for month_4 in range(InitialMonth, MonthNow + 1, 1):
            d4 = GetStrTargetdate(year, month_4, 1)
            SD = GetStockTabel(d4, TargetStock, SD)
            time.sleep(random.choice(DelayTime))
            a = a+1
            print('進度: {:.0%}'.format(a/b))

# print(SD)
# print(SD.iat[0, 0])
# print(type(SD.iat[0, 0]))

# 撰寫執行交易，並將交易日相關資訊存到dataframe中。
# TR代表Transaction Record
TR = pd.DataFrame()

fisrtdate = GetDateTargetdate(str(InitialTime))
breakpoint1 = 0
while breakpoint1 < 1:
    if GetSearchDate(fisrtdate) in list(SD['日期']):
        index = list(SD['日期']).index(GetSearchDate(fisrtdate))
        TR = pd.concat([TR, SD.iloc[[index]]], ignore_index=True)
        breakpoint1 = 1
    else:
        # 若輸入的日期沒找到，則日期再加一日來重跑迴圈
        fisrtdate = fisrtdate + datetime.timedelta(days=2)

# 此時得到儲存第一筆資料的TR
# print(TR)
